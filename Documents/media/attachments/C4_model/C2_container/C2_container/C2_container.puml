@startuml PineConePro_ERPIMS_C2
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

LAYOUT_WITH_LEGEND()

Person(owner, "Owner / GM")
Person(opsManager, "Operations Manager")
Person(purchasingLead, "Purchasing Lead")
Person(warehouseAssoc, "Warehouse Associate (RF)")
Person(csr, "Customer Service Rep")
Person(ecomManager, "E-Commerce Manager")
Person(accountant, "Accountant")
Person(itAdmin, "IT Administrator")
Person_Ext(b2bCustomer, "B2B/B2C Customer")

System_Boundary(erpBoundary, "PineCone Pro ERP/IMS") {
  Container(spa, "Angular SPA", "Angular, TypeScript", "Responsive UI for internal users, B2B/B2C portal, POS dashboard")
  Container(apigw, "Azure Application Gateway", "Azure WAF / App Gateway", "Terminates TLS, enforces WAF, routes traffic to API/SPA")
  Container(appService, "ERP Modular Monolith API", "ASP.NET Core", "Modular monolith exposing REST & GraphQL APIs, orchestrates domain workflows")
  Container_Boundary(dataBoundary, "Data & Messaging") {
    ContainerDb(db, "Operational Database", "Azure SQL Database", "Multi-schema transactional store for all ERP modules")
    Container(cache, "Caching Tier", "Azure Cache for Redis", "Accelerates read-heavy catalog, pricing, session data")
    Container(queue, "Event & Message Bus", "Azure Service Bus (Topics/Queues)", "Asynchronous workflows, integration handoffs")
    Container(blob, "Document Storage", "Azure Blob Storage", "Stores attachments, hazmat docs, reports, exports")
    Container(keyvault, "Secret Management", "Azure Key Vault", "Stores credentials, API keys, certificates")
  }
  Container(monitor, "Observability Stack", "Azure Monitor / Application Insights / Log Analytics", "Collects metrics, traces, logs, alerting")
}

System_Ext(identityProvider, "Microsoft Entra ID", "SSO, MFA, RBAC claims issuance")
System_Ext(paymentGateway, "Payment Gateway & Fraud Service", "Authorize/capture payments, fraud screening")
System_Ext(taxService, "Tax Calculation Service", "Jurisdictional tax rates, compliance filings")
System_Ext(carriers, "Carrier APIs", "Rate shopping, label purchase, tracking (UPS/FedEx/USPS)")
System_Ext(threePL, "3PL Provider", "Inventory sync, fulfillment status")
System_Ext(accountingSystem, "Accounting / GL System", "QuickBooks / NetSuite for AR/AP/GL")
System_Ext(salesChannels, "E-Commerce Channels", "Web storefront, Amazon, B2B portal, POS")
System_Ext(observabilityOps, "Ops Team Tooling", "Dashboards, incident response (Teams/PagerDuty)")
System_Ext(ciCd, "Azure DevOps Pipeline", "Build/test/deploy pipeline, artifact registry")
System_Ext(vendorEDI, "Vendor EDI Systems", "Phase 2: PO/ASN/Invoice exchange")
System_Ext(rfDevices, "RF Scanners & Mobile Apps", "Warehouse handhelds running SPA")

Rel(b2bCustomer, spa, "Browses catalog, places orders")
Rel(owner, spa, "Monitors KPIs, approves spend")
Rel(opsManager, spa, "Runs warehouse dashboards")
Rel(purchasingLead, spa, "Plans replenishment")
Rel(warehouseAssoc, rfDevices, "Uses" )
Rel(rfDevices, spa, "Responsive UI, offline cache")
Rel(csr, spa, "Manages orders, RMAs")
Rel(ecomManager, spa, "Maintains catalog")
Rel(accountant, spa, "Runs financial reports")
Rel(itAdmin, spa, "Admin UI, config")

Rel(spa, apigw, "HTTPS")
Rel(apigw, spa, "Serves static assets")
Rel(apigw, appService, "Routes API calls, enforces security policies")
Rel(appService, db, "CRUD via EF Core, stored procedures")
Rel(appService, cache, "Read/write cached data")
Rel(appService, queue, "Publishes/consumes domain events")
Rel(appService, blob, "Stores/reads documents, exports")
Rel(appService, keyvault, "Retrieves secrets at runtime")
Rel(appService, monitor, "Emits metrics, logs, traces")
Rel(monitor, observabilityOps, "Sends alerts, dashboards")

Rel(apigw, identityProvider, "Validates tokens, enforces RBAC")
Rel(appService, identityProvider, "Validates access tokens, obtains claims")
Rel(appService, paymentGateway, "Authorize payments, capture, refunds", "REST/HTTPS")
Rel(appService, taxService, "Calculate & commit tax")
Rel(appService, carriers, "Rate shop, label purchase, tracking updates")
Rel(appService, threePL, "Sync orders & inventory", "API/EDI")
Rel(appService, accountingSystem, "Post journals, invoices", "API/ETL")
Rel(appService, salesChannels, "Push catalog, inventory, status", "REST/Webhooks")
Rel(salesChannels, appService, "Submit orders, customer updates")
Rel(appService, vendorEDI, "Phase 2: PO/ASN/Invoice via EDI")
Rel(ciCd, appService, "Build & deploy container images")
Rel(ciCd, apigw, "Deploy configuration (IaC)")
Rel(ciCd, db, "Apply migrations (controlled access)")
Rel(queue, accountingSystem, "Async integration events", "Topics/Queues")
Rel(queue, threePL, "Async fulfillment events", "Topics/Queues")
Rel(queue, salesChannels, "Outbound notifications", "Topics/Queues")
Rel(queue, vendorEDI, "Future EDI message handling")
Rel(monitor, ciCd, "Quality gates, telemetry feedback")
Rel(appService, observabilityOps, "Runbook links, alert context")

@enduml
