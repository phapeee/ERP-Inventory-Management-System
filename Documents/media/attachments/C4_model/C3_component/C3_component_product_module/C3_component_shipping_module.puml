@startuml PineConePro_ERPIMS_C3_ShippingModule
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

LAYOUT_WITH_LEGEND()

Person(shippingClerk, "Shipping Clerk", "Runs pack/ship station, prints labels")
Person(opsManager, "Operations Manager", "Monitors carrier performance, hazmat compliance")

Container_Boundary(shipBoundary, "Shipping & Hazmat Module") {
  Component(shipController, "ShippingController", "ASP.NET Core", "REST endpoints for shipment planning, label purchase, hazmat validation")
  Component(shipAppService, "ShippingApplicationService", "Application layer", "Coordinates rate shopping, packing, dispatch workflows")
  Component(rateShopper, "RateShopping Engine", "Domain service", "Evaluates carrier options, service levels, cost")
  Component(hazmatValidator, "Hazmat Compliance Validator", "Domain policy", "Validates hazardous classification, packaging, documentation")
  Component(packingWorkflow, "Pack & Scan Workflow", "Domain service", "Guides cartonization, scan-to-pack, manifest generation")
  Component(shipmentAggregate, "Shipment Aggregate", "Domain model", "Tracks shipment state, carrier selection, tracking, hazmat docs")
  Component(labelService, "LabelService", "Adapter orchestration", "Requests labels, manifests, customs docs from carriers")
  Component(shippingRepository, "ShippingRepository", "EF Core repository", "Persists shipments, packages, hazmat records")
  Component(shippingReadModel, "ShippingReadModel", "CQRS read store", "Provides dashboard views, SLA tracking, exceptions")
  Component(eventPublisher, "ShippingEventPublisher", "Event dispatcher", "Emits shipment-dispatched, delivery-confirmed, hazmat-doc-uploaded")
  Component(integrationAdapters, "Carrier & 3PL Adapters", "Adapters", "REST/SOAP connectors for UPS/FedEx/USPS/3PL")
  Component(notificationService, "Notification & Tracking Service", "Background worker", "Pushes tracking updates, customer notifications")
  Component(exportManager, "Manifest & Docs Exporter", "Document generator", "Produces hazmat, customs, end-of-day manifests")
  Component(analyticsEmitter, "ShippingMetricsEmitter", "Telemetry", "Reports on SLA adherence, cost, damage rate")
}

ContainerDb(sqlDb, "Operational Database", "Azure SQL", "Shipping & hazmat schemas")
Container(blob, "Document Store", "Azure Blob Storage", "Hazmat SDS, labels, manifests")
Container(queue, "Azure Service Bus", "Topics/Queues", "Events & async tasks")
System_Ext(orderModule, "Order Module", "Provides pick confirmations, shipment requests")
System_Ext(inventoryModule, "Inventory Module", "Confirms pick completion, bin location data")
System_Ext(productModule, "Product Module", "Hazard codes, dimensions, packaging")
System_Ext(carriers, "Carrier APIs", "Rate quotes, labels, tracking, hazmat approvals")
System_Ext(threePL, "3PL Provider", "Drop-ship & cross-dock integration")
System_Ext(paymentGateway, "Payment Gateway", "Collects shipping charges when required")
System_Ext(taxModule, "Tax & Accounting Module", "Needs freight cost, hazmat fees for journals")
System_Ext(observability, "Observability Stack", "Logs, metrics, alerts")
System_Ext(customerComms, "Customer Notification Service", "Email/SMS portal for tracking updates")

Rel(shippingClerk, shipController, "Plan shipments, print labels")
Rel(opsManager, shipController, "Monitor exceptions, configure carriers")

Rel(shipController, shipAppService, "Execute workflow")
Rel(shipAppService, rateShopper, "Request cost/service comparisons")
Rel(shipAppService, hazmatValidator, "Validate hazmat requirements")
Rel(shipAppService, packingWorkflow, "Guide packing steps")
Rel(shipAppService, shipmentAggregate, "Update shipment state")
Rel(shipmentAggregate, shippingRepository, "Persist state")
Rel(shippingRepository, sqlDb, "Save/load data")
Rel(shipAppService, shippingReadModel, "Query dashboards")
Rel(shippingReadModel, sqlDb, "Read projections")
Rel(shipAppService, labelService, "Request labels/manifests")
Rel(labelService, integrationAdapters, "Invoke carrier APIs")
Rel(integrationAdapters, carriers, "REST/SOAP label purchase, rate quotes, pickups")
Rel(integrationAdapters, threePL, "Send drop-ship instructions, receive status")
Rel(shipAppService, hazmatValidator, "Generate SDS requirements")
Rel(hazmatValidator, blob, "Store compliance docs")
Rel(exportManager, blob, "Archive manifests, hazmat docs")
Rel(shipAppService, exportManager, "Generate documents")
Rel(shipAppService, eventPublisher, "Emit shipment events")
Rel(eventPublisher, queue, "Publish shipment-dispatched, delivery events")
Rel(queue, orderModule, "Notify status updates")
Rel(queue, inventoryModule, "Trigger inventory adjustments (ATP release)")
Rel(queue, taxModule, "Notify freight charges, hazmat fees")
Rel(queue, customerComms, "Push tracking notifications")
Rel(notificationService, queue, "Listen for tracking updates, send notifications")
Rel(notificationService, customerComms, "Deliver email/SMS updates")
Rel(notificationService, carriers, "Poll/push tracking events")
Rel(shipAppService, paymentGateway, "Capture shipping fees when needed")
Rel(shipAppService, productModule, "Retrieve hazmat attributes, dimensions")
Rel(shipAppService, inventoryModule, "Verify picks, location info")
Rel(shipAppService, orderModule, "Update order fulfillment state")
Rel(shipAppService, analyticsEmitter, "Send SLA, cost metrics")
Rel(analyticsEmitter, observability, "Publish metrics, alerts")
Rel(shipController, observability, "Telemetry, audit logs")
Rel(integrationAdapters, observability, "Integration health logs")

@enduml
