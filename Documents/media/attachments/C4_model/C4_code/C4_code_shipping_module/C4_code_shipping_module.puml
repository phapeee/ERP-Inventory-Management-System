@startuml PineConePro_ERPIMS_C4_ShippingModule
!include ../C4_Code.puml

LAYOUT_WITH_LEGEND()

Boundary(shipApi, "API Layer") {
  Code(shippingController, "ShippingController", "ASP.NET Core Controller", "Plan shipments, print labels, manage carrier settings.")
  Code(hazmatController, "HazmatController", "ASP.NET Core Controller", "Upload SDS, validate hazmat packaging, run audits.")
}

Boundary(shipApp, "Application Layer") {
  Code(shippingAppService, "ShippingApplicationService", "Service", "Orchestrates rate shopping, packing, dispatch workflows.")
  Code(hazmatAppService, "HazmatApplicationService", "Service", "Enforces hazardous material rules, documentation.")
  Code(rateShoppingHandler, "RateShoppingHandler", "Handler", "Evaluates carrier rates, transit times, account rules.")
  Code(packWorkflow, "PackWorkflowHandler", "Workflow", "Guides cartonization, scan-to-pack, manifest generation.")
  Code(dispatchWorkflow, "DispatchWorkflowHandler", "Workflow", "Confirms pickup, updates shipment state, notifies stakeholders.")
  Code(shippingValidator, "ShippingValidator", "FluentValidation", "Validates ship-from, hazmat requirements, carrier constraints.")
}

Boundary(shipDomain, "Domain Layer") {
  Code(shipmentAggregate, "ShipmentAggregate", "DDD Aggregate", "Tracks shipment lifecycle, parcels, tracking, compliance state.")
  Code(packageEntity, "PackageEntity", "Entity", "Represents cartons, weight, dims, hazmat flags.")
  Code(hazmatPolicy, "HazmatPolicy", "Domain Policy", "Checks DOT/IATA rules, packaging instructions, carrier eligibility.")
  Code(rateRules, "CarrierRateRule", "Domain Policy", "Applies account-specific surcharges, service level preferences.")
  Code(shippingEvents, "ShippingDomainEvents", "Event Definitions", "shipment-dispatched, label-generated, hazmat-doc-uploaded.")
}

Boundary(shipInfra, "Infrastructure & Integration") {
  Code(shippingRepository, "ShippingRepository", "EF Core Repository", "Persists shipments, packages, hazmat records.")
  Code(shippingProjector, "ShippingStatusProjector", "Projection", "Builds dashboards for SLA, exceptions, carrier KPIs.")
  Code(labelGateway, "CarrierLabelGateway", "Adapter", "Abstracts carrier APIs for rate quotes, labels, pickups.")
  Code(upsAdapter, "UpsAdapter", "Adapter", "Implements UPS REST/SOAP calls for rates, labels, hazmat forms.")
  Code(fedexAdapter, "FedExAdapter", "Adapter", "Implements FedEx WebServices/REST.")
  Code(uspsAdapter, "UspsAdapter", "Adapter", "Implements USPS API.")
  Code(threePlAdapter, "ThreePlAdapter", "Adapter", "Sends drop-ship manifests, retrieves status.")
  Code(notificationPublisher, "ShippingNotificationPublisher", "Integration Publisher", "Enqueues tracking notifications to queue/email.")
  Code(trackingListener, "TrackingListener", "Background Worker", "Polls carrier APIs/webhooks for tracking updates.")
  Code(hazmatDocStore, "HazmatDocumentStore", "Blob Client", "Stores SDS, manifests, hazardous documentation.")
  Code(shippingEventPublisher, "ShippingEventPublisher", "Event Dispatcher", "Publishes shipping domain events to Service Bus.")
  Code(shippingCache, "ShippingCache", "Redis Cache", "Caches rate quotes, packaging templates, label URLs.")
  Code(paymentClient, "ShippingPaymentClient", "Adapter", "Charges freight fees when necessary.")
}

Rel(shippingController, shippingAppService, "Invokes")
Rel(hazmatController, hazmatAppService, "Invokes")
Rel(shippingAppService, shippingValidator, "Validates")
Rel(shippingAppService, rateShoppingHandler, "Executes rate shopping")
Rel(shippingAppService, packWorkflow, "Guides packing")
Rel(shippingAppService, dispatchWorkflow, "Handles dispatch")
Rel(hazmatAppService, hazmatPolicy, "Checks compliance")
Rel(shippingAppService, shipmentAggregate, "Mutates aggregate")
Rel(shipmentAggregate, packageEntity, "Composes")
Rel(shipmentAggregate, shippingRepository, "Persist")
Rel(shippingRepository, shippingProjector, "Trigger projection")
Rel(shippingProjector, shippingCache, "Warm dashboards")
Rel(rateShoppingHandler, rateRules, "Consults")
Rel(rateShoppingHandler, labelGateway, "Request quotes")
Rel(packWorkflow, labelGateway, "Request labels/manifests")
Rel(dispatchWorkflow, trackingListener, "Subscribe for tracking")
Rel(labelGateway, upsAdapter, "Route request")
Rel(labelGateway, fedexAdapter, "Route request")
Rel(labelGateway, uspsAdapter, "Route request")
Rel(labelGateway, threePlAdapter, "Send manifest")
Rel(hazmatAppService, hazmatDocStore, "Store docs")
Rel(shipmentAggregate, shippingEvents, "Emit events")
Rel(shippingEvents, shippingEventPublisher, "Dispatch")
Rel(dispatchWorkflow, notificationPublisher, "Notify stakeholders")
Rel(notificationPublisher, paymentClient, "Optional freight charge")
Rel(trackingListener, shippingRepository, "Update status")
Rel(trackingListener, notificationPublisher, "Push updates")
Rel(shippingAppService, shippingCache, "Cache rates")
Rel(packWorkflow, paymentClient, "Capture shipping fees (if COD)")

@enduml
