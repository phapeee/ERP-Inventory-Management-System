@startuml Order Fulfillment Flow
!include ../../C4_model/C4_Sequence.puml

title Order Fulfillment (Order Capture â†’ Shipment)

Participant_UI(customer, "Customer / Channel", "Web/B2B/POS")
Participant_Controller(orderController, "Orders API", "OrderController")
Participant_App(orderApp, "Order App Service", "OrderApplicationService")
Participant_Aggregate(orderAgg, "Order Aggregate")
Participant_Policy(allocationPolicy, "Allocation Policy")
Participant_Saga(orderSaga, "Fulfillment Saga")
Participant_Payment(paymentFacade, "Payment Facade")
Participant_Inventory(inventoryFacade, "Inventory Reservation")
Participant_Shipping(shippingFacade, "Shipping Client")
Participant_Tax(taxFacade, "Tax Client")
Participant_EventBus(eventBus, "Service Bus", "Order Events Topic")
Participant_Accounting(accountingPublisher, "Accounting Publisher")
Participant_ShippingModule(shippingModule, "Shipping Module")
Participant_InventoryModule(inventoryModule, "Inventory Module")
Participant_Analytics(analyticsModule, "Analytics Module")

customer -> orderController : POST /api/orders
orderController -> orderApp : CreateOrder(command)
orderApp -> taxFacade : CalculateTax(request)
taxFacade --> orderApp : TaxResult
orderApp -> allocationPolicy : DetermineATP(order)
allocationPolicy --> orderApp : ReservationPlan
orderApp -> orderAgg : Apply(CreateOrder)
orderAgg --> orderApp : OrderCreatedEvent
orderApp -> orderSaga : StartFulfillment(orderId)
orderSaga -> paymentFacade : AuthorizePayment(order)
paymentFacade --> orderSaga : PaymentAuthorized
orderSaga -> inventoryFacade : ReserveInventory(order)
inventoryFacade --> orderSaga : ReservationConfirmed
orderSaga -> shippingFacade : PrepareShipment(order)
shippingFacade --> orderSaga : ShipmentPlanned
orderSaga -> orderAgg : Apply(PaymentCaptured, InventoryReserved)
orderAgg --> orderSaga : OrderUpdatedEvents
orderSaga -> accountingPublisher : Publish(OrderRevenueRecognized)
accountingPublisher --> eventBus : Event
orderSaga -> eventBus : Publish(OrderPaid, OrderFulfilled)
orderSaga -> shippingModule : DispatchShipment
shippingModule --> eventBus : ShipmentDispatched
shippingModule -> inventoryModule : NotifyPickComplete
inventoryModule --> eventBus : InventoryAdjusted
orderSaga -> analyticsModule : RecordKPI
analyticsModule --> eventBus : MetricUpdated
orderSaga --> orderApp : FulfillmentComplete
orderApp --> orderController : OrderResponse
orderController --> customer : 201 Created + Order summary

@enduml
