@startuml Order Fulfillment Flow
!include ../../C4_model/C4_Sequence.puml

title Order Fulfillment (Order Capture â†’ Shipment)

Participant_UI(customer, "Customer / Channel", "Web/B2B/POS")
Participant_Controller(orderController, "Orders API", "OrderController")
Participant_App(orderApp, "Order Service (AKS)", "OrderApplicationService")
Participant_Aggregate(orderAgg, "Order Aggregate")
Participant_Policy(allocationPolicy, "Allocation Policy")
Participant_Payment(paymentFacade, "Payment Facade")
Participant_Inventory(inventoryFacade, "Inventory Reservation")
Participant_Shipping(shippingFacade, "Shipping Client")
Participant_Tax(taxFacade, "Tax Client")
Participant_EventBus(eventBus, "Service Bus", "Order Events Topic")
Participant_Accounting(accountingPublisher, "Accounting Publisher")
Participant_ShippingModule(shippingModule, "Shipping Module")
Participant_InventoryModule(inventoryModule, "Inventory Module")
Participant_Analytics(analyticsModule, "Analytics Module")

customer -> orderController : POST /api/orders
orderController -> orderApp : CreateOrder(command)
orderApp -> taxFacade : CalculateTax(request)
taxFacade --> orderApp : TaxResult
orderApp -> allocationPolicy : DetermineATP(order)
allocationPolicy --> orderApp : ReservationPlan
orderApp -> orderAgg : Apply(CreateOrder)
orderAgg --> orderApp : OrderCreatedEvent
orderApp -> paymentFacade : AuthorizePayment(order)
paymentFacade --> orderApp : PaymentAuthorized
orderApp -> inventoryFacade : ReserveInventory(order)
inventoryFacade --> orderApp : ReservationConfirmed
orderApp -> shippingFacade : PrepareShipment(order)
shippingFacade --> orderApp : ShipmentPlanned
orderApp -> orderAgg : Apply(PaymentCaptured, InventoryReserved)
orderAgg --> orderApp : OrderUpdatedEvents
orderApp -> accountingPublisher : Publish(OrderRevenueRecognized)
accountingPublisher --> eventBus : Event
orderApp -> eventBus : Publish(OrderPaid, OrderFulfilled)
orderApp -> shippingModule : DispatchShipment
shippingModule -> eventBus : Publish(ShipmentDispatched)
eventBus -> inventoryModule : Consume(ShipmentDispatched)
inventoryModule -> eventBus : Publish(InventoryAdjusted)
orderApp -> analyticsModule : RecordKPI
analyticsModule --> eventBus : MetricUpdated
orderApp --> orderController : OrderResponse
orderController --> customer : 201 Created + Order summary

@enduml
